import rclpy
from rclpy.node import Node
from std_msgs.msg import Int32, Bool
import time

from pymycobot.mycobot280 import MyCobot280

class RobotA1Node(Node):
    def __init__(self):
        super().__init__('robot_a1_node')

        # MyCobot ì—°ê²°
        self.mc = MyCobot280('/dev/ttyJETCOBOT', 1000000)
        self.mc.thread_lock = True
        self.get_logger().info("ğŸ¤– JetCobot A ì—°ê²° ì™„ë£Œ")

        # âœ… í¼ë¸”ë¦¬ì…” ë° ì„œë¸ŒìŠ¤í¬ë¼ì´ë²„ ìƒì„±
        self.ready_pub = self.create_publisher(Bool, '/a_1_ready', 10)
        self.done_pub = self.create_publisher(Bool, '/a_1_done', 10)
        self.create_subscription(Int32, '/robot_a_1_node', self.step_callback, 10)

        # âœ… ì¤€ë¹„ ì‹ í˜¸ ë°˜ë³µ ë°œí–‰ (0.5ì´ˆë§ˆë‹¤)
        self.create_timer(0.5, self.publish_ready)

        # âœ… ì™„ë£Œ ì‹ í˜¸ ì¬ë°œí–‰ì„ ìœ„í•œ íƒ€ì´ë¨¸ (0.1ì´ˆë§ˆë‹¤)
        self.create_timer(0.1, self.publish_done_if_needed)

        # âœ… ë™ì‘ ì¬ì‹¤í–‰ ê°ì‹œ íƒ€ì´ë¨¸ (2ì´ˆë§ˆë‹¤)
        self.create_timer(2.0, self.check_step_timeout)

        # âœ… ì´ˆê¸° ìƒíƒœ
        self.step_done = False
        self.executing_step = None
        self.last_step_time = None

        # âœ… ì´ˆê¸°í™”
        self.mc.send_angles([0, 0, 0, 0, 0, 0], 30)
        self.mc.set_gripper_value(100, 30)
        time.sleep(2)
        self.get_logger().info("ğŸ”„ ì¤€ë¹„ ìì„¸ ì™„ë£Œ")

        self.ready_log_printed = False

        # âœ… ë™ì‘ í…Œì´ë¸”
        self.action_map = {
            101: [-30, 0, -70, -20, 0, 45, 100],
            102: [0, 0, -150, 60, -60, 45, 100],
            103: [0, 0, -150, 60, 0, 45, 0],
            104: [0, 0, -40, -45, 0, 45, 0],
            105: [0, -55, -47, 11, 0, 45, 0],
            106: [0, -55, -47, 11, 0, 45, 100],
            107: [0, 0, -40, -45, 0, 45, 0],
            108: [0, 0, -150, 60, -60, 45, 100],
            109: [0, 0, -150, 60, 0, 45, 0],
            110: [0, 0, -40, -45, 0, 45, 0],
            111: [0, -47, -48, 8, 0, 45, 100],
            112: [-30, 0, -70, -20, 0, 45, 100],


            201: [-30, 0, -70, -20, 0, 45, 100],    # ì´ˆê¸°
            202: [0, -47, -48, 8, -60, 45, 100],    # ì‹íŒ1 ìœ„ì¹˜
            203: [0, -47, -48, 8, 0, 45, 0],        # ì‹íŒ1 ì¡ê¸°
            204: [0, 0, -40, -45, 0, 45, 0],        # ì‹íŒ ë“¤ê¸°
            205: [-160, -47, -48, 8, 0, -45, 0],    # íšŒì „
            206: [-160, -47, -48, 8, -60, -45, 100], # ë²„ë¦¬ê¸°
            207: [0, 0, 0, -90, 0, 45, 100],        # ì´ˆê¸°2
            208: [0, -55, -47, 11, -60, 45, 100],   # ì‹íŒ2 ìœ„ì¹˜
            209: [0, -55, -47, 11, 0, 45, 0],       # ì‹íŒ2 ì¡ê¸°
            210: [0, 0, -40, -45, 0, 45, 0],        # ë“¤ê¸°
            211: [-160, -47, -48, 8, 0, -45, 0],    # íšŒì „
            212: [-160, -47, -48, 8, -60, -45, 100], # ë²„ë¦¬ê¸°
            213: [-30, 0, -70, -20, 0, 45, 100],    # ì´ˆê¸°
        }

    def publish_ready(self):
        if not self.ready_log_printed:
            self.get_logger().info("ğŸ“¡ ì¤€ë¹„ ì‹ í˜¸ ë°œí–‰ (/a_1_ready)")
            self.ready_log_printed = True  # âœ… ì´í›„ë¶€í„° ì¶œë ¥í•˜ì§€ ì•ŠìŒ
        self.ready_pub.publish(Bool(data=True))


    def step_callback(self, msg):
        step = msg.data
        if step == self.executing_step:
            # ë™ì¼í•œ step ì¬ìˆ˜ì‹  ì‹œ ë¬´ì‹œ
            return

        self.executing_step = step
        self.last_step_time = time.time()

        if step in self.action_map:
            angles = self.action_map[step]
            self.get_logger().info(f"â–¶ï¸ [A-1] Step {step} ë™ì‘ ì‹¤í–‰: {angles}")
            try:
                self.mc.send_angles(angles[:6], 30)
                self.mc.set_gripper_value(angles[6], 30)
                time.sleep(2)
                self.get_logger().info(f"âœ… [A-1] Step {step} ì™„ë£Œ")
                self.step_done = True
            except Exception as e:
                self.get_logger().error(f"âŒ Step {step} ì‹¤íŒ¨: {e}")
        else:
            self.get_logger().warn(f"âš ï¸ Step {step}ì€ Aê°€ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŒ")
            self.step_done = True

    def publish_done_if_needed(self):
        if self.step_done:
            self.done_pub.publish(Bool(data=True))
            self.get_logger().info("ğŸ“¤ ì™„ë£Œ ì‹ í˜¸ ì „ì†¡ (/a_1_done)")
            self.step_done = False
            self.executing_step = None
            self.last_step_time = None

    def check_step_timeout(self):
        if self.executing_step is not None and self.last_step_time is not None:
            elapsed = time.time() - self.last_step_time
            if elapsed > 5.0:
                self.get_logger().warn(f"â±ï¸ Step {self.executing_step} íƒ€ì„ì•„ì›ƒ ë°œìƒ â†’ ê°•ì œ ì¬ì‹¤í–‰")
                # ì¬ì‹¤í–‰ ì‹œë„
                self.step_callback(Int32(data=self.executing_step))  # ì¬ì „ì†¡

def main(args=None):
    rclpy.init(args=args)
    node = RobotA1Node()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    node.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
