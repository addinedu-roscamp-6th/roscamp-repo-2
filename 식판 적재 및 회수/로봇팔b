import rclpy
from rclpy.node import Node
from std_msgs.msg import Int32, Bool
import time

from pymycobot.mycobot280 import MyCobot280

class RobotB1Node(Node):
    def __init__(self):
        super().__init__('robot_b1_node')

        # JetCobot ì—°ê²°
        self.mc = MyCobot280('/dev/ttyJETCOBOT', 1000000)
        self.mc.thread_lock = True
        self.get_logger().info("ğŸ¤– JetCobot B ì—°ê²° ì™„ë£Œ")

        # ì´ˆê¸° ìì„¸
        self.mc.send_angles([0, 0, 0, 0, 0, 0], 30)
        self.mc.set_gripper_value(100, 30)
        time.sleep(2)
        self.get_logger().info("ğŸ”„ ì¤€ë¹„ ìì„¸ ì™„ë£Œ")

        # í† í”½ ì„¤ì •
        self.done_pub = self.create_publisher(Bool, '/b_1_done', 10)
        self.create_subscription(Int32, '/robot_b_1_node', self.step_callback, 10)

        # íƒ€ì´ë¨¸ ë“±ë¡
        self.create_timer(0.1, self.publish_done_if_needed)     # ì™„ë£Œ ì‹ í˜¸ ë°˜ë³µ ë°œí–‰
        self.create_timer(2.0, self.check_step_timeout)         # step ì¬ì‹¤í–‰ íƒ€ì´ë¨¸

        # ìƒíƒœ ë³€ìˆ˜
        self.step_done = False
        self.executing_step = None
        self.last_step_time = None

        # ìˆ˜í–‰í•  ë™ì‘ ì •ì˜
        self.action_map = {
            102: [0, 0, -150, 60, -60, 45, 100],
            103: [0, 0, -150, 60, -20, 45, 0],
            104: [0, 0, -40, -45, -20, 45, 0],
            105: [0, -55, -47, 11, -20, 45, 0],
            106: [0, -55, -47, 11, -20, 45, 100],
            107: [0, 0, -40, -45, 0, 45, 0],
            108: [0, 0, -150, 60, -60, 45, 100],
            109: [0, 0, -150, 60, -20, 45, 0],
            110: [0, 0, -40, -45, -20, 45, 0],
            111: [0, -47, -48, 8, -20, 45, 100],
            112: [0, 0, 0, 0, 0, 45, 100],


         
            201: [0, 0, 0, 0, 0, 45, 100],         # ì´ˆê¸° ìì„¸
            202: [0, -47, -48, 8, -60, 45, 100],   # ì‹íŒ1 ìœ„ì¹˜ ì ‘ê·¼
            203: [0, -47, -48, 8, -20, 45, 0],     # ì‹íŒ1 ì§‘ê¸° (ê·¸ë¦¬í¼ ë‹«ê¸°)
            204: [0, 0, -40, -45, -20, 45, 100],     # ë“¤ê¸° ë° ì´ë™
            205: [90, 0, 0, 0, 0, 45, 100],         # ë²„ë¦¬ê¸° ë° ì´ˆê¸°í™”

            208: [0, -55, -47, 11, -60, 45, 100],  # ì‹íŒ2 ìœ„ì¹˜ ì ‘ê·¼
            209: [0, -55, -47, 11, -20, 45, 0],    # ì‹íŒ2 ì§‘ê¸°
            210: [0, 0, -40, -45, -20, 45, 100],     # ë“¤ê¸° ë° ì´ë™
            211: [90, 0, 0, 0, 0, 45, 100],        # ë²„ë¦¬ê¸° ë° ì´ˆê¸°í™”


        }

    def step_callback(self, msg):
        step = msg.data
        if step == self.executing_step:
            # ë™ì¼í•œ step ì¬ìˆ˜ì‹  â†’ ë¬´ì‹œ
            return

        self.executing_step = step
        self.last_step_time = time.time()

        if step in self.action_map:
            angles = self.action_map[step]
            self.get_logger().info(f"â–¶ï¸ [B-1] Step {step} ë™ì‘ ì‹¤í–‰: {angles}")
            try:
                self.mc.send_angles(angles[:6], 30)
                self.mc.set_gripper_value(angles[6], 30)
                time.sleep(2)
                self.get_logger().info(f"âœ… [B-1] Step {step} ì™„ë£Œ")
                self.step_done = True
            except Exception as e:
                self.get_logger().error(f"âŒ Step {step} ì‹¤íŒ¨: {e}")
        else:
            self.get_logger().warn(f"âš ï¸ Step {step}ì€ Bê°€ ìˆ˜í–‰í•  ìˆ˜ ì—†ìŒ")
            self.step_done = True

    def publish_done_if_needed(self):
        if self.step_done:
            self.done_pub.publish(Bool(data=True))
            self.get_logger().info("ğŸ“¤ ì™„ë£Œ ì‹ í˜¸ ì „ì†¡ (/b_1_done)")
            self.step_done = False
            self.executing_step = None
            self.last_step_time = None

    def check_step_timeout(self):
        if self.executing_step is not None and self.last_step_time is not None:
            elapsed = time.time() - self.last_step_time
            if elapsed > 5.0:
                self.get_logger().warn(f"â±ï¸ Step {self.executing_step} íƒ€ì„ì•„ì›ƒ â†’ ì¬ì‹¤í–‰ ì‹œë„")
                self.step_callback(Int32(data=self.executing_step))  # ê°•ì œ ì¬ì‹¤í–‰

def main(args=None):
    rclpy.init(args=args)
    node = RobotB1Node()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    node.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
